name: Deploy Apigee Proxy

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Auth to Google Cloud with Workload Identity Federation
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/508284363122/locations/global/workloadIdentityPools/github-pool/providers/github-provider-v2'
          service_account: 'sa-ci-cd-github@primal-gate-456620-t1.iam.gserviceaccount.com'

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Check if API exists
        id: check_api
        run: |
          API_EXISTS=$(gcloud apigee apis describe my-proxy --project=primal-gate-456620-t1 --format="value(name)" || echo "not-found")
          echo "API_EXISTS=$API_EXISTS" >> $GITHUB_ENV

      - name: Create Apigee API Proxy if not exists
        if: env.API_EXISTS == 'not-found'
        run: |
          gcloud apigee apis create \
            --api=my-proxy \
            --source=./proxies/my-proxy.zip \
            --project=primal-gate-456620-t1

      - name: Deploy Apigee Proxy
        if: env.API_EXISTS != 'not-found'
        run: |
          gcloud apigee apis deploy \
            --api=my-proxy \
            --source=./proxies/my-proxy.zip \
            --project=primal-gate-456620-t1

      - name: Deploy to eval environment
        run: |
          gcloud apigee deployments create \
            --api=my-proxy \
            --environment=eval \
            --revision=1 \
            --project=primal-gate-456620-t1
